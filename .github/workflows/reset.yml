name: Nuclear Clean

on:
  workflow_dispatch:
  # å¼ºåˆ¶å¼€å¯ pull_requestï¼Œè¿™ä¼šè®©æˆ‘ä»¬æœ‰æœºä¼šåœ¨æ£€å‡ºä»£ç å‰è¿è¡Œæ¸…ç†
  pull_request:
    branches: [ main ]

jobs:
  self-destruct:
    runs-on: ubuntu-latest
    # å…³é”®ï¼šä½¿ç”¨è¿™ä¸ª Actionï¼Œå®ƒä¼šåœ¨ç¯å¢ƒåˆå§‹åŒ–å¤±è´¥æ—¶ä¹Ÿå°è¯•è¿è¡Œæ¸…ç†
    steps:
      - name: ğŸ”¥ Nuke Cache and Docker
        uses: nick-invision/run-down@v1
        with:
          # è¿™é‡Œçš„å‘½ä»¤ä¼šåœ¨ RUNNER å¯åŠ¨æ—¶ç«‹å³æ‰§è¡Œï¼Œä¸ç­‰å®ƒåˆå§‹åŒ–å®Œ
          run: |
            echo "ã€ç´§æ€¥ã€‘æ­£åœ¨å¼ºåˆ¶æ¸…ç†ç£ç›˜ï¼Œä¸ç­‰å¾…ç³»ç»Ÿå°±ç»ª..."
            # åœæ­¢ Docker
            sudo service docker stop || true
            
            # ç‰©ç†åˆ é™¤ Docker æ•°æ®ï¼ˆæœ€å½»åº•ï¼‰
            sudo rm -rf /var/lib/docker || true
            
            # æ¸…ç† Runner è‡ªå·±çš„ç¼“å­˜ï¼ˆè¿™æ˜¯å¯¼è‡´ä½ æŠ¥é”™ Worker.log çš„å…ƒå‡¶ï¼‰
            sudo rm -rf /home/runner/actions-runner/_work/_tool || true
            sudo rm -rf /home/runner/actions-runner/_work/_temp || true
            
            # é‡å»ºç›®å½•
            sudo mkdir -p /var/lib/docker
            sudo service docker start || true
            
            # æ‰“å°æœ€åçš„æ•‘å‘½ç¨»è‰æ•°æ®
            echo "æ¸…ç†åç£ç›˜çŠ¶æ€ï¼š"
            df -hT || true

      # è¿™ä¸€æ­¥å…¶å®ä¸ä¼šè¿è¡Œï¼Œå› ä¸ºæˆ‘ä»¬ä¸Šé¢å·²ç»æŠŠç¯å¢ƒæå´©äº†ï¼Œä½†æ²¡å…³ç³»ï¼Œæ¸…ç†ç›®çš„å·²è¾¾åˆ°
      - name: Break on purpose to trigger cleanup
        run: exit 1
